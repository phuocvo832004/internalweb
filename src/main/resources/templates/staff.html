<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">

    <title>Staff Page</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://code.jquery.com/ui/3.6.1/themes/base/jquery-ui.css">
	<link rel="stylesheet" th:href="@{/css/staffPageStyles.css}" />
	<style>
	    .ui-autocomplete {
	        z-index: 1050 !important; 
	        max-height: 200px;
	        overflow-y: auto; 
	        overflow-x: hidden; 
	        background-color: white;
	        border: 1px solid #ccc; 
	        border-radius: 4px; 
	        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
	        transition: all 0.3s ease;
			max-width: 350px;
			width: auto;
	    }
	    .ui-menu-item {
	        padding: 10px 15px; 
	        cursor: pointer;
	        font-size: 14px; 
	        transition: background-color 0.3s ease; 
	    }
		.ui-menu-item:hover {
		    background-color: #f5f5f5; 
		    color: #333;
		}

	    .ui-helper-hidden-accessible {
	        display: none; 
	    }
	    .custom-autocomplete {
	        position: relative;
	        display: inline-block;
	    }
	    .custom-autocomplete input {
	        width: 100%;
	        padding: 10px 15px;
	        border: 1px solid #ccc;
	        border-radius: 4px;
	        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
	        transition: border-color 0.3s ease;
	    }
	    .custom-autocomplete input:focus {
	        border-color: #007bff;
	        outline: none;
	        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
	    }
	</style>
</head>

<body>
	<input type="hidden" id="loggedInUserId" th:value="${loggedInUser.userId}">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="nav-left">
            <a class="navbar-brand" href="http://localhost:8080/introduction">Internal Web üíÄ</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="http://localhost:8080/introduction">Gi·ªõi thi·ªáu</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">L·ªãch ph√≤ng</a>
                    </li>
                    <li class="nav-item request dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                            onclick="showOptions()">Y√™u c·∫ßu</a>
                        <div class="dropdown-menu request-options" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="#" onclick="showCreateModal()">T·∫°o y√™u c·∫ßu</a>
                            <a class="dropdown-item" href="#" onclick="showSendedRequestModal()">Xem y√™u c·∫ßu ƒë√£ g·ª≠i</a>
                            <a class="dropdown-item" href="#">X·ª≠ l√Ω y√™u c·∫ßu</a>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPersonalInfoModal()">Th√¥ng tin c√° nh√¢n</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="nav-right">
            <a href="/logout" class="btn btn-outline-danger">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        Y√™u c·∫ßu ƒëang x·ª≠ l√Ω
                    </div>
                    <div class="card-body">
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-header">
                        Y√™u c·∫ßu ch∆∞a x·ª≠ l√Ω
                    </div>
                    <div class="card-body">
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <h2>Danh s√°ch th√¥ng b√°o</h2>
                <hr>
                <div class="row" id="notificationList">
                </div>
                <nav aria-label="Page navigation">
                    <ul id="pagination" class="pagination justify-content-center"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Popup details -->
    <div class="modal fade" id="fullPostModal" tabindex="-1" role="dialog" aria-labelledby="fullPostModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #cc6600; color: white;">
                    <h5 class="modal-title" id="fullPostModalLabel">Chi ti·∫øt th√¥ng b√°o</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <img id="modalAvatar" src="https://via.placeholder.com/150"
                            class="img-fluid rounded-circle custom-size random-avatar" alt="Author Avatar">
                        <h4 class="mt-2" id="modalAuthor">T√°c gi·∫£</h4>
                        <p class="text-muted">Ng√†y ƒëƒÉng: <span id="modalDatePosted">01/01/2024</span></p>
                    </div>
                    <div class="mb-3">
                        <h4>Ti√™u ƒë·ªÅ:</h4>
                        <p id="modalTitle">Ti√™u ƒë·ªÅ th√¥ng b√°o</p>
                    </div>
                    <div class="mb-3">
                        <h4>N·ªôi dung:</h4>
                        <p id="modalContent">N·ªôi dung th√¥ng b√°o</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal"
                        style="background-color: #cc6600;">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="personalInfoModal" tabindex="-1" role="dialog" aria-labelledby="personalInfoModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="personalInfoModalLabel">Th√¥ng tin c√° nh√¢n</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <label for="avatarUpload" class="d-block mb-3">
                            <img id="avatarPreview" th:src="${loggedInUser.avatar}" alt="Avatar"
                                class="avatar-image rounded-circle" style="height: 200px; width: 200px;">
                        </label>
                        <span class="text-primary" style="cursor:pointer"
                            onclick="document.getElementById('avatarUpload').click()">Thay ƒë·ªïi h√¨nh ƒë·∫°i di·ªán</span>
                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;"
                            onchange="previewAvatar(event)">
                    </div>
                    <form id="personalInfoForm">
                        <div class="form-group">
                            <label for="fullName">H·ªç v√† t√™n: </label>
                            <input type="text" class="form-control" id="fullName" th:value="${loggedInUser.fullName}">
                        </div>
                        <div class="form-group">
                            <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                            <input type="text" class="form-control" id="phone" th:value="${loggedInUser.phone}">
                        </div>
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="text" class="form-control" id="email" th:value="${loggedInUser.email}">
                        </div>
                        <div class="form-group">
                            <label for="position">Ch·ª©c v·ª•:</label>
                            <input type="text" class="form-control" id="position" th:value="${loggedInUser.position}"
                                disabled>
                        </div>
                        <div class="form-group">
                            <label for="department">Ph√≤ng ban:</label>
                            <input type="text" class="form-control" id="department"
                                th:value="${loggedInUser.department}" disabled>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="confirmUpdatePersonalInfo()"
                        data-dismiss="modal">L∆∞u thay ƒë·ªïi</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>
	
	<!-- Modal for creating request -->
		<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
		    <div class="modal-dialog" role="document">
		        <div class="modal-content">
		            <div class="modal-header">
		                <h5 class="modal-title" id="createModalLabel">T·∫°o y√™u c·∫ßu</h5>
		                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		                    <span aria-hidden="true">&times;</span>
		                </button>
		            </div>
		            <div class="modal-body">
		                <!-- Create form -->
		                <form id="createForm" action="/create" method="post">
							<div class="form-group">
							    <label for="emailReceiver">Ng∆∞·ªùi nh·∫≠n</label>
							    <input type="email" class="form-control" id="emailReceiver" name="emailReceiver">
							</div>
		                    <div class="form-group">
		                        <label for="title">Ti√™u ƒë·ªÅ</label>
		                        <input type="text" class="form-control" id="title" name="title">
		                    </div>
		                    <div class="form-group">
		                        <label for="content">N·ªôi dung</label>
		                        <textarea class="form-control" id="content" name="content" rows="3"></textarea>
		                    </div>

		                </form>
		            </div>
		            <div class="modal-footer">
		                <button type="button" class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
		                <button type="submit" form="createForm" class="btn btn-primary" id="submitBtn">G·ª≠i</button>
		            </div>
		        </div>
		    </div>
		</div>
		
		<!-- Modal for viewing requests -->
		<div class="modal fade" id="viewRequestsModal" tabindex="-1" role="dialog" aria-labelledby="viewRequestsModalLabel" aria-hidden="true">
		    <div class="modal-dialog modal-lg" role="document">
		        <div class="modal-content">
		            <div class="modal-header">
		                <h5 class="modal-title" id="viewRequestsModalLabel">Y√™u c·∫ßu ƒë√£ g·ª≠i</h5>
		                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		            </div>
		            <div class="modal-body">
		                <div class="table-responsive">
		                    <table class="table table-bordered table-striped">
		                        <thead>
		                            <tr>
		                                <th>Ti√™u ƒë·ªÅ</th>
		                                <th>N·ªôi dung</th>
		                                <th>Email ng∆∞·ªùi nh·∫≠n</th>
		                                <th>Ng√†y g·ª≠i</th>
										<th>Tr·∫°ng th√°i</th>
		                            </tr>
		                        </thead>
		                        <tbody id="requestsTableBody">
		                            <!-- Rows will be inserted here dynamically using JavaScript -->
		                        </tbody>
		                    </table>
		                </div>
		            </div>
		            <div class="modal-footer">
		                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="hideModal()">ƒê√≥ng</button>
		            </div>
		        </div>
		    </div>
		</div>



		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            // M·∫£ng ch·ª©a c√°c URL c·ªßa c√°c h√¨nh ·∫£nh ƒë·∫°i di·ªán
            var avatars = [
                './images/ava1.svg',
                './images/ava2.svg',
                './images/ava3.svg',
                './images/ava4.svg'
            ];

            var randomIndex = Math.floor(Math.random() * avatars.length);
            var randomAvatar = avatars[randomIndex];

            document.querySelector('.random-avatar').src = randomAvatar;
        });
		$(document).ready(function () {
		    $("#emailReceiver").autocomplete({
		        source: function (request, response) {
		            $.ajax({
		                url: "/api/users/receiver/search",
		                dataType: "json",
		                data: {
		                    query: request.term
		                },
		                success: function (data) {
							console.log(data);
		                    response(data.map(function (item) {
		                        return {
		                            label: item.fullName + " (" + item.email + ")",
		                            value: item.email
		                        };
		                    }));
		                }
		            });
		        },
		        minLength: 1 
		    });
		});

		$(document).ready(function () {
		    $("#submitBtn").click(function () {
				event.preventDefault();
		        var title = $("#title").val();
		        var content = $("#content").val();
		        var emailReceiver = $("#emailReceiver").val();
		        var userId = parseInt(document.getElementById('loggedInUserId').value.trim());
				
				if (!title || !content || !emailReceiver) {
				            alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.");
				            return;
				        }

		        var requestData = {
		            title: title,
		            comments: content,
		            processedBy: emailReceiver,
		            userId: userId,
		            status: "Pending"
		        };

		        fetch("/api/request/create", {
		            method: "POST",
		            headers: {
		                "Content-Type": "application/json"
		            },
		            body: JSON.stringify(requestData)
		        })
		        .then(() => {
		            $("#createModal").modal("hide");
					window.location.href = "/staff";
		        });
		    });
		});

		function displaySentRequests(userId) {
		    fetch(`/api/request/sended-request/${userId}`)
		        .then(response => {
		            if (!response.ok) {
		                throw new Error('Network response was not ok');
		            }
		            return response.json();
		        })
		        .then(data => {
		            const modalBody = document.getElementById('requestsTableBody');
		            modalBody.innerHTML = ''; 

		            data.forEach(request => {
		                const row = document.createElement('tr');

		                // Chuy·ªÉn ƒë·ªïi ng√†y t·ª´ chu·ªói th√†nh ƒë·ªëi t∆∞·ª£ng Date
		                const dateSubmitted = new Date(request.dateSubmitted);
		                // ƒê·ªãnh d·∫°ng l·∫°i ng√†y theo ƒë·ªãnh d·∫°ng mong mu·ªën (v√≠ d·ª•: dd/mm/yyyy)
		                const formattedDate = `${dateSubmitted.getDate()}/${dateSubmitted.getMonth() + 1}/${dateSubmitted.getFullYear()}`;

		                row.innerHTML = `
		                    <td>${request.title}</td>
		                    <td>${request.comments}</td>
		                    <td>${request.processedBy}</td>
		                    <td>${formattedDate}</td>
		                    <td>${request.status}</td>
		                `;
		                modalBody.appendChild(row);
		            });
		        })
		        .catch(error => {
		            console.error('There was a problem fetching the sent requests:', error);
		        });
		}

		// Add an event listener to the modal to load requests when it is shown
		$('#viewRequestsModal').on('show.bs.modal', function (event) {
		    const modal = $(this);
			const userId = parseInt(document.getElementById('loggedInUserId').value.trim()); 
		    displaySentRequests(userId);
		});

        function previewAvatar(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function () {
                document.getElementById('avatarPreview').src = reader.result;
                // G·ª≠i t·ªáp ƒë·∫øn m√°y ch·ªß ƒë·ªÉ c·∫≠p nh·∫≠t avatar
                updateAvatar(file);
            };
            if (file) {
                reader.readAsDataURL(file);
            }
        }

        function updateAvatar(file) {
            const formData = new FormData();
            formData.append('avatar', file);

            $.ajax({
                url: '/api/users/update-avatar', // Endpoint ƒë·ªÉ c·∫≠p nh·∫≠t avatar
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    alert('Avatar ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!');
                },
                error: function (xhr, status, error) {
                    console.error('Error updating avatar:', error);
                }
            });
        }

        var currentPage = 1;
        var totalPages = 2;

        $(document).ready(function () {
            loadDataAndPagination();
        });

        function loadDataAndPagination() {
            $.ajax({
                url: "/api/internal-news?page=" + currentPage + "&size=9",
                method: "GET",
                success: function (response) {
                    var notificationList = $('#notificationList');
                    notificationList.empty();
                    response.content.forEach(function (news) {
                        var item = $('<div class="col-md-4 mb-4">' +
                            '<div class="card">' +
                            '<div class="card-body">' +
                            '<h5 class="card-title">' + news.title + '</h5>' +
                            '<h6 class="card-subtitle mb-2 text-muted">' + news.datePosted + '</h6>' +
                            '<p class="card-text">' + news.content + '</p>' +
                            '</div>' +
                            '</div>' +
                            '</div>');
                        item.click(function () {

                            showFullPost(news.newsId);

                        });
                        notificationList.append(item);
                    });

                    totalPages = response.totalPages;
                    renderPagination();
                },
                error: function (xhr, status, error) {
                    console.error("Error loading data:", error);
                }
            });
        }
        function showFullPost(newsId) {
            $.ajax({
                url: "/api/internal-news/" + newsId,
                method: "GET",
                success: function (response) {
                    $('#modalTitle').text(response.title);
                    $('#modalContent').text(response.content);
                    $('#modalAuthor').text(response.author);
                    $('#modalDatePosted').text(response.datePosted);
                    $('#fullPostModal').modal('show');
                },
                error: function (xhr, status, error) {
                    console.error("Error loading full post:", error);
                }
            });
        }



        function renderPagination() {
            var paginationHtml = '';

            paginationHtml += '<li class="page-item ' + (currentPage === 1 ? 'disabled' : '') + '">';
            paginationHtml += '<a class="page-link" href="#" onclick="changePage(' + (currentPage - 1) + ')">Previous</a>';
            paginationHtml += '</li>';

            for (var i = 1; i <= totalPages; i++) {
                paginationHtml += '<li class="page-item ' + (i === currentPage ? 'active' : '') + '">';
                paginationHtml += '<a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a>';
                paginationHtml += '</li>';
            }

            paginationHtml += '<li class="page-item ' + (currentPage === totalPages ? 'disabled' : '') + '">';
            paginationHtml += '<a class="page-link" href="#" onclick="changePage(' + (currentPage + 1) + ')">Next</a>';
            paginationHtml += '</li>';

            $('.pagination').html(paginationHtml);
        }

        function changePage(page) {
            currentPage = page;
            loadDataAndPagination();
        }

        function showOptions() {
            var requestOptions = document.querySelector('.request-options');
            requestOptions.classList.toggle('show-options');
        }
        function showPersonalInfoModal() {
            $('#personalInfoModal').modal('show');
        }

        function confirmUpdatePersonalInfo() {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u thay ƒë·ªïi kh√¥ng?")) {
                updatePersonalInfo();
            }
        }

        function updatePersonalInfo() {
            const userId = parseInt(document.getElementById('loggedInUserId').value.trim()); 
            const fullName = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const position = document.getElementById('position').value;
            const department = document.getElementById('department').value;

            const updatedUser = {
                fullName: fullName,
                phone: phone,
                email: email,
                position: position,
                department: department,
            };

            $.ajax({
                url: `/api/users/${userId}`,
                method: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify(updatedUser),
                success: function (response) {
                    alert('Th√¥ng tin c√° nh√¢n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng.');
                },
                error: function (xhr) {
                    alert('ƒê√£ c√≥ l·ªói x·∫£y ra: ' + xhr.responseText);
                }
            });
        }
		
		function showCreateModal() {
		    $('#createModal').modal('show'); 
		}

		function showSendedRequestModal() {
			        $('#viewRequestsModal').modal('show'); 
			    }
				function hideModal() {
					 $('#viewRequestsModal').modal('hide');
				}

    </script>
</body>

</html>